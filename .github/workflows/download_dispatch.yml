name: ä¸‹è½½JMæœ¬å­ (dispatch)

on:
  workflow_dispatch:
    inputs:
      JM_ALBUM_IDS:
        type: string
        description: æœ¬å­idï¼ˆå¤šä¸ªidç”¨-éš”å¼€ï¼Œå¦‚ '123-456-789'ï¼‰
        required: false

      JM_PHOTO_IDS:
        type: string
        description: ç« èŠ‚idï¼ˆå•ç‹¬ä¸‹è½½ç« èŠ‚ï¼Œå¤šä¸ªidåŒä¸Šï¼‰
        required: false

      CLIENT_IMPL:
        type: string
        description: å®¢æˆ·ç«¯ç±»å‹ï¼ˆclient.implï¼‰ï¼Œä¸‹è½½å¤±è´¥æ—¶ï¼Œä½ å¯ä»¥å°è¯•å¡«å…¥æ­¤é¡¹é‡è¯•ã€‚'api' è¡¨ç¤ºç§»åŠ¨ç«¯ï¼Œ'html' è¡¨ç¤ºç½‘é¡µç«¯ã€‚
        default: ''
        required: false

      IMAGE_SUFFIX:
        type: string
        description: å›¾ç‰‡åç¼€ï¼ˆdownload.cache.suffixï¼‰ï¼Œé»˜è®¤ä¸ºç©ºï¼Œè¡¨ç¤ºä¸åšå›¾ç‰‡æ ¼å¼è½¬æ¢ã€‚å¯å¡«å…¥ä¾‹å¦‚ 'png' 'jpg'
        default: ''
        required: false

      DIR_RULE:
        type: string
        description: ä¸‹è½½æ–‡ä»¶å¤¹è§„åˆ™ï¼ˆdir_rule.ruleï¼‰ã€‚é»˜è®¤ä½¿ç”¨é…ç½®æ–‡ä»¶çš„ 'Bd_Aauthor_Atitle_Pindex'ã€‚
        default: ''
        required: false
        
      # â­ ä¿®æ”¹ï¼šæ”¹ä¸ºé€‰æ‹©è¾“å‡ºæ ¼å¼
      OUTPUT_FORMAT:
        type: choice
        description: è¾“å‡ºæ ¼å¼é€‰æ‹©
        required: true
        default: 'pdf_only'
        options:
          - pdf_only       # åªä¿ç•™PDFï¼ˆåˆ é™¤åŸå›¾ï¼‰
          - images_only    # åªä¿ç•™åŸå›¾ï¼ˆä¸è½¬PDFï¼‰

      # é‚®ä»¶é€‰é¡¹
      EMAIL_TO_INPUT:
        type: string
        description: æ”¶ä»¶äººé‚®ç®±ï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™ä¸å‘é€é‚®ä»¶ï¼‰
        default: ''
        required: false
        
      ZIP_NAME:
        type: string
        default: æœ¬å­.tar.gz
        description: å‹ç¼©æ–‡ä»¶åç§°
        required: false

      UPLOAD_NAME:
        type: string
        default: Click me to download
        description: ä¸Šä¼ æ–‡ä»¶åç§°
        required: false


jobs:
  crawler:
    runs-on: ubuntu-latest
    env:
      # å·¥ä½œæµè¾“å…¥
      JM_ALBUM_IDS: ${{ github.event.inputs.JM_ALBUM_IDS }}
      JM_PHOTO_IDS: ${{ github.event.inputs.JM_PHOTO_IDS }}
      DIR_RULE: ${{ github.event.inputs.DIR_RULE }}
      CLIENT_IMPL: ${{ github.event.inputs.CLIENT_IMPL }}
      ZIP_NAME: ${{ github.event.inputs.ZIP_NAME }}
      UPLOAD_NAME: ${{ github.event.inputs.UPLOAD_NAME }}
      IMAGE_SUFFIX: ${{ github.event.inputs.IMAGE_SUFFIX }}
      OUTPUT_FORMAT: ${{ github.event.inputs.OUTPUT_FORMAT }}  # â­ æ–°å¢ï¼šè¾“å‡ºæ ¼å¼
      
      # ç™»å½•ç›¸å…³secrets
      JM_USERNAME: ${{ secrets.JM_USERNAME }}
      JM_PASSWORD: ${{ secrets.JM_PASSWORD }}

      # é‚®ä»¶ç›¸å…³secrets
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      EMAIL_TO: ${{ github.event.inputs.EMAIL_TO_INPUT || secrets.EMAIL_TO }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      EMAIL_TITLE: ${{ secrets.EMAIL_TITLE }}
      EMAIL_CONTENT: ${{ secrets.EMAIL_CONTENT }}

      # å›ºå®šå€¼
      JM_DOWNLOAD_DIR: /home/runner/work/jmcomic/download/

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependency
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          
      # â­ ä¿®æ”¹ï¼šæ ¹æ®é€‰æ‹©å†³å®šæ˜¯å¦å®‰è£… img2pdf
      - name: å®‰è£… img2pdfï¼ˆä»…PDFæ¨¡å¼ï¼‰
        if: ${{ github.event.inputs.OUTPUT_FORMAT == 'pdf_only' }}
        run: |
          pip install img2pdf
          echo "âœ… å·²å®‰è£… img2pdfï¼ˆPDFè½¬æ¢æ¨¡å¼ï¼‰"
          
      - name: å®‰è£…jmcomicï¼ˆpipï¼‰
        if: ${{ github.ref != 'refs/heads/dev' }}
        run: |
          pip install jmcomic -i https://pypi.org/project --upgrade

      - name: å®‰è£…jmcomicï¼ˆlocalï¼‰
        if: ${{ github.ref == 'refs/heads/dev' }}
        run: |
          pip install -e ./
          
      # â­ æ–°å¢ï¼šæ˜¾ç¤ºå½“å‰è¾“å‡ºæ¨¡å¼
      - name: æ˜¾ç¤ºè¾“å‡ºæ¨¡å¼
        run: |
          echo "========================================"
          echo "ğŸ“¦ è¾“å‡ºæ¨¡å¼é…ç½®"
          echo "========================================"
          if [ "$OUTPUT_FORMAT" = "pdf_only" ]; then
            echo "ğŸ“„ æ¨¡å¼: åªä¿ç•™PDFï¼ˆå°†åˆ é™¤åŸå§‹å›¾ç‰‡ï¼‰"
            echo "   - âœ… å¯ç”¨ PDF è½¬æ¢"
            echo "   - âŒ æœ€ç»ˆåˆ é™¤åŸå§‹å›¾ç‰‡"
          else
            echo "ğŸ–¼ï¸  æ¨¡å¼: åªä¿ç•™åŸå›¾ï¼ˆä¸è¿›è¡ŒPDFè½¬æ¢ï¼‰"
            echo "   - âŒ ä¸è¿›è¡Œ PDF è½¬æ¢"
            echo "   - âœ… ä¿ç•™åŸå§‹å›¾ç‰‡"
          fi
          echo "========================================"
          
      # â­ æ–°å¢ï¼šæ ¹æ®æ¨¡å¼ä¿®æ”¹é…ç½®æ–‡ä»¶
      - name: é…ç½®ä¸‹è½½é€‰é¡¹
        run: |
          CONFIG_FILE="assets/option/option_workflow_download.yml"
          
          if [ "$OUTPUT_FORMAT" = "images_only" ]; then
            # åªä¿ç•™åŸå›¾æ¨¡å¼ï¼šæ³¨é‡Šæ‰ img2pdf æ’ä»¶
            echo "ğŸ”§ ç¦ç”¨ PDF è½¬æ¢æ’ä»¶..."
            sed -i '/after_album:/,/pdf_dir:/ s/^/#/' "$CONFIG_FILE"
            sed -i '/filename_rule: Aname/,/^  after_download:/ s/^/#/' "$CONFIG_FILE"
            echo "âœ… å·²ç¦ç”¨ PDF è½¬æ¢"
          else
            echo "âœ… ä¿æŒ PDF è½¬æ¢æ’ä»¶å¯ç”¨"
          fi
          
          echo "å½“å‰é…ç½®æ–‡ä»¶å†…å®¹ï¼š"
          cat "$CONFIG_FILE"
          
      - name: æ£€æŸ¥é‚®ä»¶é…ç½®
        run: |
          echo "========================================"
          echo "ğŸ“§ é‚®ä»¶é…ç½®æ£€æŸ¥"
          echo "========================================"
          
          if [ -n "$EMAIL_FROM" ]; then
            echo "âœ… EMAIL_FROM: ${EMAIL_FROM:0:3}***@${EMAIL_FROM##*@}"
          else
            echo "âŒ EMAIL_FROM: æœªé…ç½®"
          fi
          
          if [ -n "$EMAIL_TO" ]; then
            echo "âœ… EMAIL_TO: ${EMAIL_TO:0:3}***@${EMAIL_TO##*@}"
          else
            echo "âŒ EMAIL_TO: æœªé…ç½®ï¼ˆä¸ä¼šå‘é€é‚®ä»¶ï¼‰"
          fi
          
          if [ -n "$EMAIL_PASS" ]; then
            echo "âœ… EMAIL_PASS: ${EMAIL_PASS:0:4}************"
          else
            echo "âŒ EMAIL_PASS: æœªé…ç½®"
          fi
          
          if [ -n "$EMAIL_TITLE" ]; then
            echo "âœ… EMAIL_TITLE: $EMAIL_TITLE"
          else
            echo "âš ï¸  EMAIL_TITLE: æœªé…ç½®ï¼ˆå°†ä½¿ç”¨é»˜è®¤æ ‡é¢˜ï¼‰"
          fi
          
          if [ -n "$EMAIL_CONTENT" ]; then
            echo "âœ… EMAIL_CONTENT: $EMAIL_CONTENT"
          else
            echo "âš ï¸  EMAIL_CONTENT: æœªé…ç½®ï¼ˆå°†ä½¿ç”¨é»˜è®¤å†…å®¹ï¼‰"
          fi
          
          echo "========================================"
          
          if [ -z "$EMAIL_FROM" ] || [ -z "$EMAIL_TO" ] || [ -z "$EMAIL_PASS" ]; then
            echo "âš ï¸  è­¦å‘Š: é‚®ä»¶é…ç½®ä¸å®Œæ•´ï¼Œå°†ä¸ä¼šå‘é€é‚®ä»¶"
          else
            echo "âœ… é‚®ä»¶é…ç½®å®Œæ•´ï¼Œä¸‹è½½å®Œæˆåå°†å‘é€é‚®ä»¶"
          fi
          
      - name: è¿è¡Œä¸‹è½½è„šæœ¬
        run: |
          cd ./usage/
          python workflow_download.py
          
      # â­ ä¿®æ”¹ï¼šæ ¹æ®æ¨¡å¼å¤„ç†æ–‡ä»¶
      - name: å¤„ç†è¾“å‡ºæ–‡ä»¶
        run: |
          cd $JM_DOWNLOAD_DIR
          
          if [ "$OUTPUT_FORMAT" = "pdf_only" ]; then
            echo "ğŸ“„ å¤„ç†æ¨¡å¼ï¼šåªä¿ç•™PDF"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # ç»Ÿè®¡åŸå§‹æ–‡ä»¶
            IMAGE_COUNT=$(find . -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" -o -name "*.webp" \) | wc -l)
            echo "ğŸ“Š åŸå§‹å›¾ç‰‡æ•°é‡: $IMAGE_COUNT"
            
            # åˆ é™¤åŸå§‹å›¾ç‰‡
            find . -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" -o -name "*.webp" \) -delete
            rm -f ã€å‡ºé”™äº†ã€‘*.log
            find . -type d -empty -delete
            
            echo "âœ… å·²åˆ é™¤åŸå§‹å›¾ç‰‡ï¼Œåªä¿ç•™PDFæ–‡ä»¶"
            
          elif [ "$OUTPUT_FORMAT" = "images_only" ]; then
            echo "ğŸ–¼ï¸  å¤„ç†æ¨¡å¼ï¼šåªä¿ç•™åŸå›¾"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # åˆ é™¤PDFç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "pdf" ]; then
              PDF_COUNT=$(find pdf -name "*.pdf" 2>/dev/null | wc -l)
              echo "ğŸ“Š åˆ é™¤ PDF æ–‡ä»¶æ•°é‡: $PDF_COUNT"
              rm -rf pdf
            fi
            
            # ç»Ÿè®¡ä¿ç•™çš„å›¾ç‰‡
            IMAGE_COUNT=$(find . -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" -o -name "*.webp" \) | wc -l)
            echo "ğŸ“Š ä¿ç•™çš„å›¾ç‰‡æ•°é‡: $IMAGE_COUNT"
            
            rm -f ã€å‡ºé”™äº†ã€‘*.log
            find . -type d -empty -delete
            
            echo "âœ… å·²åˆ é™¤PDFæ–‡ä»¶ï¼Œåªä¿ç•™åŸå§‹å›¾ç‰‡"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ æœ€ç»ˆæ–‡ä»¶ç»Ÿè®¡ï¼š"
          du -sh . 2>/dev/null | awk '{print "æ€»å¤§å°: " $1}'
          find . -type f | wc -l | awk '{print "æ–‡ä»¶æ•°é‡: " $1}'
          
      # â­ ä¿®æ”¹ï¼šæ ¹æ®æ¨¡å¼æ£€æŸ¥æ–‡ä»¶
      - name: æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
        run: |
          echo "========================================"
          echo "ğŸ“‚ æ–‡ä»¶æ£€æŸ¥"
          echo "========================================"
          
          if [ "$OUTPUT_FORMAT" = "pdf_only" ]; then
            if [ -d "$JM_DOWNLOAD_DIR/pdf" ]; then
              PDF_COUNT=$(find $JM_DOWNLOAD_DIR/pdf -name "*.pdf" 2>/dev/null | wc -l)
              echo "âœ… PDFæ¨¡å¼ - PDFæ–‡ä»¶æ•°é‡: $PDF_COUNT"
              if [ $PDF_COUNT -gt 0 ]; then
                echo ""
                echo "PDFæ–‡ä»¶åˆ—è¡¨:"
                find $JM_DOWNLOAD_DIR/pdf -name "*.pdf" -exec ls -lh {} \;
                echo ""
                echo "PDFæ€»å¤§å°: $(du -sh $JM_DOWNLOAD_DIR/pdf 2>/dev/null | cut -f1)"
              fi
            else
              echo "âš ï¸  è­¦å‘Š: PDFç›®å½•ä¸å­˜åœ¨"
            fi
            
          elif [ "$OUTPUT_FORMAT" = "images_only" ]; then
            IMAGE_COUNT=$(find $JM_DOWNLOAD_DIR -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" -o -name "*.webp" \) | wc -l)
            echo "âœ… åŸå›¾æ¨¡å¼ - å›¾ç‰‡æ–‡ä»¶æ•°é‡: $IMAGE_COUNT"
            if [ $IMAGE_COUNT -gt 0 ]; then
              echo ""
              echo "å›¾ç‰‡æ€»å¤§å°: $(du -sh $JM_DOWNLOAD_DIR 2>/dev/null | cut -f1)"
            fi
          fi
          
          echo "========================================"

      - name: å‹ç¼©æ–‡ä»¶
        run: |
          cd $JM_DOWNLOAD_DIR
          tar -zcvf "../$ZIP_NAME" ./
          mv "../$ZIP_NAME" .

      - name: ä¸Šä¼ ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.UPLOAD_NAME }}
          path: ${{ env.JM_DOWNLOAD_DIR }}/${{ env.ZIP_NAME }}
          if-no-files-found: error
          retention-days: 90
          
      # â­ ä¿®æ”¹ï¼šé‚®ä»¶é€šçŸ¥ï¼ˆé€‚é…ä¸åŒæ¨¡å¼ï¼‰
      - name: å‘é€é‚®ä»¶é€šçŸ¥
        if: ${{ env.EMAIL_TO != '' && env.EMAIL_FROM != '' && env.EMAIL_PASS != '' }}
        continue-on-error: true
        run: |
          echo "ğŸ“§ å‡†å¤‡å‘é€é‚®ä»¶..."
          
          # æ ¹æ®æ¨¡å¼è°ƒæ•´é‚®ä»¶å†…å®¹
          if [ "$OUTPUT_FORMAT" = "pdf_only" ]; then
            echo "æ¨¡å¼ï¼šPDFæ–‡ä»¶"
          else
            echo "æ¨¡å¼ï¼šåŸå§‹å›¾ç‰‡"
          fi
          
          python assets/send_email_with_pdf.py
          echo "âœ… é‚®ä»¶ä»»åŠ¡å®Œæˆ"
