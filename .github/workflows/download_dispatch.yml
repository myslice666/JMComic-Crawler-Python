name: ä¸‹è½½JMæœ¬å­ (dispatch)

on:
  workflow_dispatch:
    inputs:
      JM_ALBUM_IDS:
        type: string
        description: æœ¬å­idï¼ˆå¤šä¸ªidç”¨-éš”å¼€ï¼Œå¦‚ '123-456-789'ï¼‰
        required: false

      JM_PHOTO_IDS:
        type: string
        description: ç« èŠ‚idï¼ˆå•ç‹¬ä¸‹è½½ç« èŠ‚ï¼Œå¤šä¸ªidåŒä¸Šï¼‰
        required: false

      CLIENT_IMPL:
        type: string
        description: å®¢æˆ·ç«¯ç±»å‹ï¼ˆclient.implï¼‰ï¼Œä¸‹è½½å¤±è´¥æ—¶ï¼Œä½ å¯ä»¥å°è¯•å¡«å…¥æ­¤é¡¹é‡è¯•ã€‚'api' è¡¨ç¤ºç§»åŠ¨ç«¯ï¼Œ'html' è¡¨ç¤ºç½‘é¡µç«¯ã€‚
        default: ''
        required: false

      IMAGE_SUFFIX:
        type: string
        description: å›¾ç‰‡åç¼€ï¼ˆdownload.cache.suffixï¼‰ï¼Œé»˜è®¤ä¸ºç©ºï¼Œè¡¨ç¤ºä¸åšå›¾ç‰‡æ ¼å¼è½¬æ¢ã€‚å¯å¡«å…¥ä¾‹å¦‚ 'png' 'jpg'
        default: ''
        required: false

      DIR_RULE:
        type: string
        description: ä¸‹è½½æ–‡ä»¶å¤¹è§„åˆ™ï¼ˆdir_rule.ruleï¼‰ã€‚é»˜è®¤ä½¿ç”¨é…ç½®æ–‡ä»¶çš„ 'Bd_Aauthor_Atitle_Pindex'ã€‚
        default: ''
        required: false
        
      # â­ ä¿®æ”¹ï¼šæ”¹ä¸ºé€‰æ‹©ç±»å‹
      OUTPUT_FORMAT:
        type: choice
        description: è¾“å‡ºæ ¼å¼é€‰æ‹©
        options:
          - åªä¿ç•™PDFï¼ˆåˆ é™¤åŸå›¾ï¼‰
          - åªä¿ç•™åŸå›¾ï¼ˆä¸è½¬PDFï¼‰
        default: åªä¿ç•™PDFï¼ˆåˆ é™¤åŸå›¾ï¼‰
        required: true

      # é‚®ä»¶é€‰é¡¹
      EMAIL_TO_INPUT:
        type: string
        description: æ”¶ä»¶äººé‚®ç®±ï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™ä¸å‘é€é‚®ä»¶ï¼‰
        default: ''
        required: false
        
      ZIP_NAME:
        type: string
        default: æœ¬å­.tar.gz
        description: å‹ç¼©æ–‡ä»¶åç§°
        required: false

      UPLOAD_NAME:
        type: string
        default: Click me to download
        description: ä¸Šä¼ æ–‡ä»¶åç§°
        required: false


jobs:
  crawler:
    runs-on: ubuntu-latest
    env:
      # å·¥ä½œæµè¾“å…¥
      JM_ALBUM_IDS: ${{ github.event.inputs.JM_ALBUM_IDS }}
      JM_PHOTO_IDS: ${{ github.event.inputs.JM_PHOTO_IDS }}
      DIR_RULE: ${{ github.event.inputs.DIR_RULE }}
      CLIENT_IMPL: ${{ github.event.inputs.CLIENT_IMPL }}
      ZIP_NAME: ${{ github.event.inputs.ZIP_NAME }}
      UPLOAD_NAME: ${{ github.event.inputs.UPLOAD_NAME }}
      IMAGE_SUFFIX: ${{ github.event.inputs.IMAGE_SUFFIX }}
      OUTPUT_FORMAT: ${{ github.event.inputs.OUTPUT_FORMAT }}
      
      # ç™»å½•ç›¸å…³secrets
      JM_USERNAME: ${{ secrets.JM_USERNAME }}
      JM_PASSWORD: ${{ secrets.JM_PASSWORD }}

      # é‚®ä»¶ç›¸å…³secrets
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      EMAIL_TO: ${{ github.event.inputs.EMAIL_TO_INPUT || secrets.EMAIL_TO }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      EMAIL_TITLE: ${{ secrets.EMAIL_TITLE }}
      EMAIL_CONTENT: ${{ secrets.EMAIL_CONTENT }}

      # å›ºå®šå€¼
      JM_DOWNLOAD_DIR: /home/runner/work/jmcomic/download/

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependency
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          # â­ åªåœ¨éœ€è¦PDFæ—¶å®‰è£… img2pdf
          if [ "$OUTPUT_FORMAT" == "åªä¿ç•™PDFï¼ˆåˆ é™¤åŸå›¾ï¼‰" ]; then
            pip install img2pdf
            echo "âœ… å·²å®‰è£… img2pdf æ’ä»¶"
          else
            echo "â„¹ï¸ è·³è¿‡ img2pdf å®‰è£…ï¼ˆåªä¿ç•™åŸå›¾æ¨¡å¼ï¼‰"
          fi
          
      - name: å®‰è£…jmcomicï¼ˆpipï¼‰
        if: ${{ github.ref != 'refs/heads/dev' }}
        run: |
          pip install jmcomic -i https://pypi.org/project --upgrade

      - name: å®‰è£…jmcomicï¼ˆlocalï¼‰
        if: ${{ github.ref == 'refs/heads/dev' }}
        run: |
          pip install -e ./
          
      - name: æ£€æŸ¥é‚®ä»¶é…ç½®
        run: |
          echo "========================================"
          echo "ğŸ“§ é‚®ä»¶é…ç½®æ£€æŸ¥"
          echo "========================================"
          
          if [ -n "$EMAIL_FROM" ]; then
            echo "âœ… EMAIL_FROM: ${EMAIL_FROM:0:3}***@${EMAIL_FROM##*@}"
          else
            echo "âŒ EMAIL_FROM: æœªé…ç½®"
          fi
          
          if [ -n "$EMAIL_TO" ]; then
            echo "âœ… EMAIL_TO: ${EMAIL_TO:0:3}***@${EMAIL_TO##*@}"
          else
            echo "âŒ EMAIL_TO: æœªé…ç½®ï¼ˆä¸ä¼šå‘é€é‚®ä»¶ï¼‰"
          fi
          
          if [ -n "$EMAIL_PASS" ]; then
            echo "âœ… EMAIL_PASS: ${EMAIL_PASS:0:4}************"
          else
            echo "âŒ EMAIL_PASS: æœªé…ç½®"
          fi
          
          if [ -n "$EMAIL_TITLE" ]; then
            echo "âœ… EMAIL_TITLE: $EMAIL_TITLE"
          else
            echo "âš ï¸  EMAIL_TITLE: æœªé…ç½®ï¼ˆå°†ä½¿ç”¨é»˜è®¤æ ‡é¢˜ï¼‰"
          fi
          
          if [ -n "$EMAIL_CONTENT" ]; then
            echo "âœ… EMAIL_CONTENT: $EMAIL_CONTENT"
          else
            echo "âš ï¸  EMAIL_CONTENT: æœªé…ç½®ï¼ˆå°†ä½¿ç”¨é»˜è®¤å†…å®¹ï¼‰"
          fi
          
          echo "========================================"
          
          if [ -z "$EMAIL_FROM" ] || [ -z "$EMAIL_TO" ] || [ -z "$EMAIL_PASS" ]; then
            echo "âš ï¸  è­¦å‘Š: é‚®ä»¶é…ç½®ä¸å®Œæ•´ï¼Œå°†ä¸ä¼šå‘é€é‚®ä»¶"
          else
            echo "âœ… é‚®ä»¶é…ç½®å®Œæ•´ï¼Œä¸‹è½½å®Œæˆåå°†å‘é€é‚®ä»¶"
          fi
          
      # â­ ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®é€‰é¡¹å†³å®šæ˜¯å¦å¯ç”¨PDFè½¬æ¢
      - name: é…ç½®è¾“å‡ºæ ¼å¼
        run: |
          echo "========================================"
          echo "âš™ï¸  è¾“å‡ºæ ¼å¼é…ç½®"
          echo "========================================"
          echo "å½“å‰é€‰æ‹©: $OUTPUT_FORMAT"
          
          if [ "$OUTPUT_FORMAT" == "åªä¿ç•™åŸå›¾ï¼ˆä¸è½¬PDFï¼‰" ]; then
            echo "â„¹ï¸ ç¦ç”¨ img2pdf æ’ä»¶..."
            # æ³¨é‡Šæ‰é…ç½®æ–‡ä»¶ä¸­çš„ img2pdf æ’ä»¶
            sed -i 's/^  after_album:/#  after_album:/g' assets/option/option_workflow_download.yml
            sed -i 's/^    - plugin: img2pdf/#    - plugin: img2pdf/g' assets/option/option_workflow_download.yml
            sed -i 's/^      kwargs:/#      kwargs:/g' assets/option/option_workflow_download.yml
            sed -i 's/^        pdf_dir:/#        pdf_dir:/g' assets/option/option_workflow_download.yml
            sed -i 's/^        filename_rule:/#        filename_rule:/g' assets/option/option_workflow_download.yml
            echo "âœ… å·²ç¦ç”¨ PDF è½¬æ¢ï¼Œå°†åªä¿ç•™åŸå§‹å›¾ç‰‡"
          else
            echo "âœ… å¯ç”¨ PDF è½¬æ¢æ¨¡å¼"
          fi
          echo "========================================"
          
      - name: è¿è¡Œä¸‹è½½è„šæœ¬
        run: |
          cd ./usage/
          python workflow_download.py
          
      # â­ ä¿®æ”¹ï¼šæ ¹æ®é€‰é¡¹å¤„ç†æ–‡ä»¶
      - name: å¤„ç†è¾“å‡ºæ–‡ä»¶
        run: |
          cd $JM_DOWNLOAD_DIR
          
          if [ "$OUTPUT_FORMAT" == "åªä¿ç•™PDFï¼ˆåˆ é™¤åŸå›¾ï¼‰" ]; then
            echo "========================================"
            echo "ğŸ—‘ï¸  æ¸…ç†åŸå§‹å›¾ç‰‡ï¼ˆåªä¿ç•™PDFï¼‰"
            echo "========================================"
            
            # åˆ é™¤åŸå§‹å›¾ç‰‡
            find . -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" -o -name "*.webp" \) -delete
            rm -f ã€å‡ºé”™äº†ã€‘*.log
            find . -type d -empty -delete
            
            echo "âœ… å·²æ¸…ç†åŸå§‹å›¾ç‰‡ï¼Œåªä¿ç•™PDF"
            
          elif [ "$OUTPUT_FORMAT" == "åªä¿ç•™åŸå›¾ï¼ˆä¸è½¬PDFï¼‰" ]; then
            echo "========================================"
            echo "ğŸ—‘ï¸  æ¸…ç†PDFæ–‡ä»¶ï¼ˆåªä¿ç•™åŸå›¾ï¼‰"
            echo "========================================"
            
            # åˆ é™¤PDFç›®å½•
            if [ -d "pdf" ]; then
              rm -rf pdf
              echo "âœ… å·²åˆ é™¤ PDF ç›®å½•"
            else
              echo "â„¹ï¸ PDF ç›®å½•ä¸å­˜åœ¨ï¼ˆç¬¦åˆé¢„æœŸï¼‰"
            fi
            
            echo "âœ… ä¿ç•™åŸå§‹å›¾ç‰‡ï¼Œæœªç”ŸæˆPDF"
          fi
          
          echo "========================================"
          
      - name: æ£€æŸ¥æœ€ç»ˆæ–‡ä»¶
        run: |
          echo "========================================"
          echo "ğŸ“ æœ€ç»ˆæ–‡ä»¶æ£€æŸ¥"
          echo "========================================"
          
          cd $JM_DOWNLOAD_DIR
          
          if [ "$OUTPUT_FORMAT" == "åªä¿ç•™PDFï¼ˆåˆ é™¤åŸå›¾ï¼‰" ]; then
            if [ -d "pdf" ]; then
              PDF_COUNT=$(find pdf -name "*.pdf" 2>/dev/null | wc -l)
              echo "ğŸ“„ PDFæ–‡ä»¶æ•°é‡: $PDF_COUNT"
              echo ""
              echo "PDFæ–‡ä»¶åˆ—è¡¨:"
              find pdf -name "*.pdf" -exec ls -lh {} \; 2>/dev/null || echo "æ— PDFæ–‡ä»¶"
              echo ""
              echo "PDFæ€»å¤§å°: $(du -sh pdf 2>/dev/null | cut -f1 || echo '0')"
            else
              echo "âŒ PDFç›®å½•ä¸å­˜åœ¨"
            fi
          else
            IMAGE_COUNT=$(find . -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" -o -name "*.webp" \) 2>/dev/null | wc -l)
            echo "ğŸ–¼ï¸  å›¾ç‰‡æ–‡ä»¶æ•°é‡: $IMAGE_COUNT"
            echo ""
            echo "ä¸‹è½½ç›®å½•ç»“æ„:"
            tree -L 2 -h . 2>/dev/null || ls -lhR .
            echo ""
            echo "æ€»å¤§å°: $(du -sh . | cut -f1)"
          fi
          
          echo "========================================"

      - name: å‹ç¼©æ–‡ä»¶
        run: |
          cd $JM_DOWNLOAD_DIR
          tar -zcvf "../$ZIP_NAME" ./
          mv "../$ZIP_NAME" .

      - name: ä¸Šä¼ ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.UPLOAD_NAME }}
          path: ${{ env.JM_DOWNLOAD_DIR }}/${{ env.ZIP_NAME }}
          if-no-files-found: error
          retention-days: 90
          
      - name: å‘é€é‚®ä»¶é€šçŸ¥
        if: ${{ env.EMAIL_TO != '' && env.EMAIL_FROM != '' && env.EMAIL_PASS != '' }}
        continue-on-error: true
        run: |
          echo "ğŸ“§ å‡†å¤‡å‘é€é‚®ä»¶..."
          python assets/send_email_with_pdf.py
          echo "âœ… é‚®ä»¶ä»»åŠ¡å®Œæˆ"
