name: ä¸‹è½½JMæœ¬å­ (dispatch)

on:
  workflow_dispatch:
    inputs:
      JM_ALBUM_IDS:
        type: string
        description: æœ¬å­idï¼ˆå¤šä¸ªidç”¨-éš”å¼€ï¼Œå¦‚ '123-456-789'ï¼‰
        required: false

      JM_PHOTO_IDS:
        type: string
        description: ç« èŠ‚idï¼ˆå•ç‹¬ä¸‹è½½ç« èŠ‚ï¼Œå¤šä¸ªidåŒä¸Šï¼‰
        required: false

      CLIENT_IMPL:
        type: string
        description: å®¢æˆ·ç«¯ç±»å‹ï¼ˆclient.implï¼‰ï¼Œä¸‹è½½å¤±è´¥æ—¶ï¼Œä½ å¯ä»¥å°è¯•å¡«å…¥æ­¤é¡¹é‡è¯•ã€‚'api' è¡¨ç¤ºç§»åŠ¨ç«¯ï¼Œ'html' è¡¨ç¤ºç½‘é¡µç«¯ã€‚
        default: ''
        required: false

      IMAGE_SUFFIX:
        type: string
        description: å›¾ç‰‡åç¼€ï¼ˆdownload.cache.suffixï¼‰ï¼Œé»˜è®¤ä¸ºç©ºï¼Œè¡¨ç¤ºä¸åšå›¾ç‰‡æ ¼å¼è½¬æ¢ã€‚å¯å¡«å…¥ä¾‹å¦‚ 'png' 'jpg'
        default: ''
        required: false

      DIR_RULE:
        type: string
        description: ä¸‹è½½æ–‡ä»¶å¤¹è§„åˆ™ï¼ˆdir_rule.ruleï¼‰ã€‚é»˜è®¤ä½¿ç”¨é…ç½®æ–‡ä»¶çš„ 'Bd_Aauthor_Atitle_Pindex'ã€‚
        default: ''
        required: false
        ##åªæœ‰pdf
        
      PDF_ONLY:
        type: boolean
        description: åªä¿ç•™PDFæ–‡ä»¶ï¼ˆä¸ä¿ç•™åŸå§‹å›¾ç‰‡ï¼‰
        default: true
        required: false

          # é‚®ä»¶é€‰é¡¹
      EMAIL_TO_INPUT:
        type: string
        description: æ”¶ä»¶äººé‚®ç®±ï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™ä¸å‘é€é‚®ä»¶ï¼‰
        default: ''
        required: false
        
      ZIP_NAME:
        type: string
        default: æœ¬å­.tar.gz
        description: å‹ç¼©æ–‡ä»¶åç§°
        required: false

      UPLOAD_NAME:
        type: string
        default: Click me to download
        description: ä¸Šä¼ æ–‡ä»¶åç§°
        required: false

#      JM_USERNAME:
#        type: string
#        default: ''
#        description: 'ç¦æ¼«å¸å·ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼Œç”¨æˆ·åå’Œå¯†ç ä¼šæ³„éœ²åœ¨æ—¥å¿—ä¸­ã€‚æœ€å¥½ç”¨secretsï¼‰'
#        required: false
#
#      JM_PASSWORD:
#        type: string
#        default: ''
#        description: 'ç¦æ¼«å¯†ç ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼Œç”¨æˆ·åå’Œå¯†ç ä¼šæ³„éœ²åœ¨æ—¥å¿—ä¸­ã€‚æœ€å¥½ç”¨secretsï¼‰'
#        required: false


jobs:
  crawler:
    runs-on: ubuntu-latest
    env:
      # å·¥ä½œæµè¾“å…¥
      JM_ALBUM_IDS: ${{ github.event.inputs.JM_ALBUM_IDS }}
      JM_PHOTO_IDS: ${{ github.event.inputs.JM_PHOTO_IDS }}
      DIR_RULE: ${{ github.event.inputs.DIR_RULE }}
      CLIENT_IMPL: ${{ github.event.inputs.CLIENT_IMPL }}
      ZIP_NAME: ${{ github.event.inputs.ZIP_NAME }}
      UPLOAD_NAME: ${{ github.event.inputs.UPLOAD_NAME }}
      IMAGE_SUFFIX: ${{ github.event.inputs.IMAGE_SUFFIX }}
      PDF_ONLY: ${{ github.event.inputs.PDF_ONLY }}     #pdf
      
      # ç™»å½•ç›¸å…³secrets
      JM_USERNAME: ${{ secrets.JM_USERNAME }}
      JM_PASSWORD: ${{ secrets.JM_PASSWORD }}

      # é‚®ä»¶ç›¸å…³secrets
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      #EMAIL_TO: ${{ secrets.EMAIL_TO }}   åŸæ¥çš„ï¼Œåªä½¿ç”¨secreté‡Œé¢çš„
      EMAIL_TO: ${{ github.event.inputs.EMAIL_TO_INPUT || secrets.EMAIL_TO }}# é‚®ä»¶ç›¸å…³ - ä¼˜å…ˆä½¿ç”¨è¾“å…¥æ¡†çš„é‚®ç®±ï¼Œå…¶æ¬¡ä½¿ç”¨secrets
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      EMAIL_TITLE: ${{ secrets.EMAIL_TITLE }}
      EMAIL_CONTENT: ${{ secrets.EMAIL_CONTENT }}

      # å›ºå®šå€¼
      JM_DOWNLOAD_DIR: /home/runner/work/jmcomic/download/

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependency
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install img2pdf  #è‡ªå·±ä¿®æ”¹æ·»åŠ pdfæ’ä»¶ï¼
          
      - name: å®‰è£…jmcomicï¼ˆpipï¼‰
        if: ${{ github.ref != 'refs/heads/dev' }}
        run: |
          pip install jmcomic -i https://pypi.org/project --upgrade

      - name: å®‰è£…jmcomicï¼ˆlocalï¼‰
        if: ${{ github.ref == 'refs/heads/dev' }}
        run: |
          pip install -e ./
          
      # â­ æ·»åŠ ï¼šæ£€æŸ¥é‚®ä»¶é…ç½®
      - name: æ£€æŸ¥é‚®ä»¶é…ç½®
        run: |
          echo "========================================"
          echo "ğŸ“§ é‚®ä»¶é…ç½®æ£€æŸ¥"
          echo "========================================"
          
          if [ -n "$EMAIL_FROM" ]; then
            echo "âœ… EMAIL_FROM: ${EMAIL_FROM:0:3}***@${EMAIL_FROM##*@}"
          else
            echo "âŒ EMAIL_FROM: æœªé…ç½®"
          fi
          
          if [ -n "$EMAIL_TO" ]; then
            echo "âœ… EMAIL_TO: ${EMAIL_TO:0:3}***@${EMAIL_TO##*@}"
          else
            echo "âŒ EMAIL_TO: æœªé…ç½®ï¼ˆä¸ä¼šå‘é€é‚®ä»¶ï¼‰"
          fi
          
          if [ -n "$EMAIL_PASS" ]; then
            echo "âœ… EMAIL_PASS: ${EMAIL_PASS:0:4}************"
          else
            echo "âŒ EMAIL_PASS: æœªé…ç½®"
          fi
          
          if [ -n "$EMAIL_TITLE" ]; then
            echo "âœ… EMAIL_TITLE: $EMAIL_TITLE"
          else
            echo "âš ï¸  EMAIL_TITLE: æœªé…ç½®ï¼ˆå°†ä½¿ç”¨é»˜è®¤æ ‡é¢˜ï¼‰"
          fi
          
          if [ -n "$EMAIL_CONTENT" ]; then
            echo "âœ… EMAIL_CONTENT: $EMAIL_CONTENT"
          else
            echo "âš ï¸  EMAIL_CONTENT: æœªé…ç½®ï¼ˆå°†ä½¿ç”¨é»˜è®¤å†…å®¹ï¼‰"
          fi
          
          echo "========================================"
          
          # æ£€æŸ¥æ˜¯å¦æ»¡è¶³å‘é€æ¡ä»¶
          if [ -z "$EMAIL_FROM" ] || [ -z "$EMAIL_TO" ] || [ -z "$EMAIL_PASS" ]; then
            echo "âš ï¸  è­¦å‘Š: é‚®ä»¶é…ç½®ä¸å®Œæ•´ï¼Œå°†ä¸ä¼šå‘é€é‚®ä»¶"
          else
            echo "âœ… é‚®ä»¶é…ç½®å®Œæ•´ï¼Œä¸‹è½½å®Œæˆåå°†å‘é€é‚®ä»¶"
          fi
          
      - name: è¿è¡Œä¸‹è½½è„šæœ¬
        run: |
          cd ./usage/
          python workflow_download.py
          
      - name: å¤„ç†PDFé€‰é¡¹
        if: ${{ github.event.inputs.PDF_ONLY == 'true' }}
        run: |
          cd $JM_DOWNLOAD_DIR
          # åªä¿ç•™PDFï¼Œåˆ é™¤åŸå§‹å›¾ç‰‡
          find . -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" -o -name "*.webp" \) -delete
          rm -f ã€å‡ºé”™äº†ã€‘*.log
          find . -type d -empty -delete
          echo "âœ… å·²æ¸…ç†åŸå§‹å›¾ç‰‡ï¼Œåªä¿ç•™PDF"
          
      - name: å‹ç¼©æ–‡ä»¶
        run: |
          cd $JM_DOWNLOAD_DIR
          tar -zcvf "../$ZIP_NAME" ./
          mv "../$ZIP_NAME" .

      - name: ä¸Šä¼ ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.UPLOAD_NAME }}
          path: ${{ env.JM_DOWNLOAD_DIR }}/${{ env.ZIP_NAME }}
          if-no-files-found: error
          retention-days: 90
